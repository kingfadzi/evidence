# yaml-language-server: $schema=./schemas/ruleset.schema.json
rules:
  - id: "aws-kms-key-rotation"
    name: "Key Rotation Max"
    platform: "aws"
    service: "kms"
    description: "Verifies that customer-managed KMS keys have automatic rotation enabled."
    collection:
      apiCall: "getKeyRotationStatus"
      parameters:
        keyId: "${arn}"
      responseField: "keyRotationEnabled"
    assessment:
      compliantWhen:
        isTrue: true

  - id: "aws-secret-metadata"
    name: "Secrets Management"
    platform: "aws"
    service: "secretsmanager"
    description: "Collects metadata about a secret stored in AWS Secrets Manager."
    collection:
      apiCall: "describeSecret"
      parameters:
        secretId: "${arn}"
      responseFields:
        - "name"
        - "arn"
        - "rotationEnabled"
        - "lastChangedDate"

  - id: "aws-s3-bucket-encryption"
    name: "S3 Bucket Encryption"
    platform: "aws"
    service: "s3"
    description: "Verifies that an S3 bucket has default encryption enabled."
    collection:
      apiCall: "getBucketEncryption"
      parameters:
        bucket: "${arn.resource}"
      responseField: "serverSideEncryptionConfiguration.rules[0].applyServerSideEncryptionByDefault.sseAlgorithm"
    assessment:
      compliantWhen:
        equals: "AES256"

  - id: "aws-iam-user-policies"
    name: "IAM User Policies"
    platform: "aws"
    service: "iam"
    description: "Lists the managed policies attached to an IAM user."
    collection:
      apiCall: "listAttachedUserPolicies"
      parameters:
        userName: "${arn.resource}"
      responseField: "attachedPolicies"
